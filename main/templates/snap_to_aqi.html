{% extends 'base.html' %}
{% load static %}

{% block title %}Snap-to-AQI - Instant Air Sensor{% endblock %}

{% block extra_css %}
<style>
    .snap-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 3rem 0;
        color: white;
        text-align: center;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .upload-zone {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .upload-zone:hover {
        border-color: #764ba2;
        background: #f0f2ff;
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }
    
    .upload-zone.dragover {
        background: #e8ecff;
        border-color: #764ba2;
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .preview-container {
        max-width: 100%;
        margin-top: 2rem;
    }
    
    .preview-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .current-aqi-badge {
        display: inline-block;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 1rem 0;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .recent-card {
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .recent-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .feature-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .btn-snap {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 1rem 3rem;
        font-size: 1.2rem;
        border-radius: 50px;
        transition: all 0.3s ease;
    }
    
    .btn-snap:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    #loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loading-content {
        text-align: center;
        color: white;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-10px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .new-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: bold;
        animation: pulse-badge 2s ease-in-out infinite;
    }
    
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* RESULTS SECTION STYLES */
    .results-section {
        display: none;
        margin-top: 3rem;
        animation: fadeInUp 0.6s ease;
    }

    .results-section.show {
        display: block;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .results-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
    }

    .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .results-grid {
            grid-template-columns: 1fr;
        }
    }

    .result-image-container {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .result-image {
        width: 100%;
        height: auto;
        display: block;
    }

    .image-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .aqi-display-large {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .aqi-number {
        font-size: 5rem;
        font-weight: bold;
        margin: 1rem 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .aqi-category {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .aqi-rise-indicator {
        display: inline-block;
        background: #ff6b6b;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-weight: bold;
        margin-top: 1rem;
    }

    .aqi-rise-indicator.positive {
        background: #ff6b6b;
    }

    .aqi-rise-indicator.neutral {
        background: #95a5a6;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .detail-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }

    .detail-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .detail-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }

    .detail-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .health-impact {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        border-left: 5px solid #ff6b6b;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .health-impact h4 {
        color: #c0392b;
        margin-bottom: 1rem;
    }

    .recommendations {
        background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%);
        border-left: 5px solid #10b981;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .recommendations h4 {
        color: #059669;
        margin-bottom: 1rem;
    }

    .recommendations ul {
        margin-left: 1.5rem;
    }

    .recommendations li {
        margin-bottom: 0.5rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .btn-new-scan {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-new-scan:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .comparison-chart {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .gauge-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hero Section -->
    <div class="snap-hero">
        <h1>üì∏ Snap-to-AQI</h1>
        <p class="lead">Turn your camera into an instant air sensor</p>
        <p>Take a photo of pollution ‚Üí Get instant AQI reading ‚Üí Know your health risk</p>
    </div>

    <!-- Choose Detection Method -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="text-center">
                <h4 class="mb-3">Choose Detection Method</h4>
                <div class="row">
                    <!-- EXISTING: Upload Photo - Smoke/Haze Detection -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100" style="border: 2px solid #667eea; cursor: pointer;" onclick="showUploadSection()">
                            <div class="card-body text-center">
                                <div style="font-size: 4rem;">üå´Ô∏è</div>
                                <h5 class="mt-3">Smoke/Haze Detection</h5>
                                <p class="text-muted">Detect smoke and air haziness</p>
                                <button class="btn btn-primary" type="button">
                                    Choose This Method
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Enhanced AI Detection with YOLO -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100" style="border: 2px solid #ff7e00; cursor: pointer; position: relative;" onclick="window.location.href='{% url 'snap_to_aqi_enhanced' %}'">
                            <span class="new-badge">‚ú® NEW</span>
                            <div class="card-body text-center">
                                <div style="font-size: 4rem;">üöóüè≠</div>
                                <h5 class="mt-3">AI Object Detection</h5>
                                <p class="text-muted">Detect vehicles, construction & smoke</p>
                                <button class="btn btn-warning" type="button">
                                    Enhanced Detection
                                </button>
                                <small class="d-block mt-2 text-success" style="font-weight: bold;">
                                    ü§ñ Powered by YOLO AI
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EXISTING: Live Camera -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100" style="border: 2px solid #28a745; cursor: pointer;" onclick="window.location.href='{% url 'live_camera' %}'">
                            <div class="card-body text-center">
                                <div style="font-size: 4rem;">üìπ</div>
                                <h5 class="mt-3">Live Camera</h5>
                                <p class="text-muted">Real-time smoke detection with live feed</p>
                                <button class="btn btn-success" type="button">
                                    Start Live Detection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Current AQI Display -->
    <div class="text-center mb-4" id="aqi-display-section">
        <p class="mb-2" id="aqi-city-label">Current AQI in <strong>{{ user_city }}</strong>:</p>
        <div class="current-aqi-badge" style="background: {% if current_aqi <= 50 %}#00e400{% elif current_aqi <= 100 %}#ffff00{% elif current_aqi <= 200 %}#ff7e00{% elif current_aqi <= 300 %}#ff0000{% else %}#8f3f97{% endif %}; color: {% if current_aqi <= 100 %}#000{% else %}#fff{% endif %};">
            {{ current_aqi }} AQI
        </div>
    </div>
    
    <!-- Upload Form -->
    <div class="row" id="upload-section">
        <div class="col-md-8 mx-auto">
            <form method="POST" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üì∑</div>
                    <h3>Click or Drag to Upload Photo</h3>
                    <p class="text-muted">Capture pollution sources: smoke, dust, traffic, construction</p>
                    <input type="file" name="image" id="imageInput" accept="image/*" style="display: none;" required>
                    <button type="button" class="btn btn-snap mt-3" onclick="document.getElementById('imageInput').click()">
                        Choose Photo
                    </button>
                </div>
                
                <!-- Preview -->
                <div class="preview-container" id="previewContainer" style="display: none;">
                    <img id="previewImage" class="preview-image" src="" alt="Preview">
                    <button type="button" class="btn btn-secondary mt-3" onclick="clearImage()">
                        Change Photo
                    </button>
                </div>
                
                <!-- Location Input (Optional) -->
                <div class="mt-4">
                    <label for="location">Location (Optional):</label>
                    <input type="text" class="form-control" name="location" id="location" 
                           placeholder="e.g., Connaught Place, Delhi" value="{{ user_city }}">
                    <small class="form-text text-muted">Where was this photo taken? (Type to update AQI)</small>
                    
                    <!-- Hidden fields -->
                    <input type="hidden" name="latitude" id="latitude">
                    <input type="hidden" name="longitude" id="longitude">
                    <input type="hidden" name="current_aqi" id="current_aqi_value" value="{{ current_aqi }}">
                </div>
                
                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-snap btn-lg" id="analyzeBtn" disabled>
                        üîç Analyze Air Quality
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RESULTS SECTION (Hidden by default, shown after analysis) -->
    <div class="results-section" id="resultsSection">
        <div class="results-header">
            <h2>‚úÖ Analysis Complete!</h2>
            <p>Here's what we found in your image</p>
        </div>

        <div class="results-grid">
            <!-- Left: Image with overlay -->
            <div class="result-image-container">
                <img id="resultImage" class="result-image" src="" alt="Analyzed Image">
                <div class="image-overlay">
                    üìç <span id="resultLocation">Location</span>
                </div>
            </div>

            <!-- Right: AQI Display -->
            <div class="aqi-display-large">
                <div style="font-size: 1.2rem; color: #7f8c8d;">Predicted AQI</div>
                <div class="aqi-number" id="resultAQI" style="color: #667eea;">--</div>
                <div class="aqi-category" id="resultCategory">--</div>
                <div class="aqi-rise-indicator positive" id="resultRise">
                    ‚¨Ü +0 AQI from baseline
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #ecf0f1;">
                    <div style="color: #7f8c8d; font-size: 0.9rem;">Baseline AQI</div>
                    <div style="font-size: 2rem; font-weight: bold; color: #95a5a6;" id="baselineAQI">{{ current_aqi }}</div>
                </div>
            </div>
        </div>

        <!-- Detection Details -->
        <div class="details-grid">
            <div class="detail-card">
                <div class="detail-icon">üè≠</div>
                <div class="detail-label">Pollution Source</div>
                <div class="detail-value" id="resultSource">--</div>
            </div>
            <div class="detail-card">
                <div class="detail-icon">üìä</div>
                <div class="detail-label">Confidence Level</div>
                <div class="detail-value" id="resultConfidence">--</div>
            </div>
            <div class="detail-card">
                <div class="detail-icon">üå°Ô∏è</div>
                <div class="detail-label">Impact Level</div>
                <div class="detail-value" id="resultImpact">--</div>
            </div>
            <div class="detail-card">
                <div class="detail-icon">‚è∞</div>
                <div class="detail-label">Detected At</div>
                <div class="detail-value" id="resultTime">--</div>
            </div>
        </div>

        <!-- Health Impact -->
        <div class="health-impact" id="healthImpact">
            <h4>‚ö†Ô∏è Health Impact</h4>
            <p id="healthText">Loading health information...</p>
        </div>

        <!-- Recommendations -->
        <div class="recommendations">
            <h4>üí° Recommendations</h4>
            <ul id="recommendationsList">
                <li>Analyzing your results...</li>
            </ul>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-new-scan" onclick="resetForNewScan()">
                üì∏ Analyze Another Photo
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='{% url 'snap_history' %}'">
                üìã View History
            </button>
        </div>
    </div>
    
    <!-- Features Section -->
    <div class="row mt-5 mb-4" id="features-section">
        <div class="col-md-12">
            <h3 class="text-center mb-4">How It Works</h3>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">üì∏</div>
                <h5>1. Capture</h5>
                <p>Take a photo of pollution</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">ü§ñ</div>
                <h5>2. AI Analysis</h5>
                <p>CV model analyzes haziness</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">üìä</div>
                <h5>3. AQI Estimate</h5>
                <p>Get instant AQI reading</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card">
                <div class="feature-icon">‚ö†Ô∏è</div>
                <h5>4. Health Alert</h5>
                <p>Know your risk level</p>
            </div>
        </div>
    </div>
    
    <!-- Recent Predictions -->
    {% if recent_predictions %}
    <div class="row mt-5" id="recent-section">
        <div class="col-md-12">
            <h3 class="mb-3">Your Recent Scans</h3>
            <div class="row">
                {% for pred in recent_predictions %}
                <div class="col-md-6 mb-3">
                    <div class="card recent-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-4">
                                    <img src="{{ pred.image.url }}" class="img-fluid rounded" alt="Scan">
                                </div>
                                <div class="col-8">
                                    <h5 style="color: {{ pred.color_code }};">AQI: {{ pred.predicted_aqi }}</h5>
                                    <p class="mb-1"><strong>Source:</strong> {{ pred.get_pollution_source_display }}</p>
                                    <p class="mb-1"><strong>Rise:</strong> +{{ pred.aqi_rise }} AQI</p>
                                    <p class="text-muted small">{{ pred.created_at|timesince }} ago</p>
                                    <button class="btn btn-sm btn-primary" onclick="loadResultDetails({{ pred.id }})">View Details</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <a href="{% url 'snap_history' %}" class="btn btn-outline-primary">View All History</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Analyzing Image...</h3>
        <p>Our AI is detecting pollution sources and calculating AQI</p>
    </div>
</div>

<script>
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const uploadForm = document.getElementById('uploadForm');
    const loadingOverlay = document.getElementById('loading-overlay');
    const resultsSection = document.getElementById('resultsSection');
    
    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            imageInput.files = files;
            handleImageSelect();
        }
    });
    
    // File input change
    imageInput.addEventListener('change', handleImageSelect);
    
    function handleImageSelect() {
        const file = imageInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                uploadZone.style.display = 'none';
                previewContainer.style.display = 'block';
                analyzeBtn.disabled = false;
            }
            reader.readAsDataURL(file);
        }
    }
    
    function clearImage() {
        imageInput.value = '';
        previewImage.src = '';
        uploadZone.style.display = 'flex';
        previewContainer.style.display = 'none';
        analyzeBtn.disabled = true;
    }
    
    function showUploadSection() {
        document.getElementById('uploadZone').scrollIntoView({ behavior: 'smooth' });
    }
    
    function resetForNewScan() {
        resultsSection.classList.remove('show');
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('features-section').style.display = 'flex';
        const recentSection = document.getElementById('recent-section');
        if (recentSection) recentSection.style.display = 'block';
        clearImage();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            document.getElementById('latitude').value = position.coords.latitude;
            document.getElementById('longitude').value = position.coords.longitude;
        });
    }
    
    // Form submit - Mock analysis (replace with actual backend call)
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        loadingOverlay.style.display = 'flex';
        
        // Get current baseline AQI
        const baselineAQI = parseInt(document.getElementById('current_aqi_value').value) || {{ current_aqi }};
        
        // Simulate API call
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            showResults({
                image: previewImage.src,
                location: document.getElementById('location').value || 'Delhi',
                aqi: 185,
                category: 'Unhealthy',
                categoryColor: '#ff6b6b',
                rise: 185 - baselineAQI,
                baselineAQI: baselineAQI,
                source: 'Vehicle Emissions',
                confidence: '87%',
                impact: 'High',
                time: 'Just now',
                health: 'Air quality is unhealthy for sensitive groups. People with respiratory or heart conditions, children, and older adults should limit prolonged outdoor exertion.',
                recommendations: [
                    'Avoid prolonged outdoor activities',
                    'Use N95 masks when going outside',
                    'Keep windows and doors closed',
                    'Use air purifiers indoors',
                    'Monitor AQI levels regularly'
                ]
            });
        }, 3000);
    });
    
    function showResults(data) {
        // Hide upload section
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('features-section').style.display = 'none';
        const recentSection = document.getElementById('recent-section');
        if (recentSection) recentSection.style.display = 'none';
        
        // Populate results
        document.getElementById('resultImage').src = data.image;
        document.getElementById('resultLocation').textContent = data.location;
        document.getElementById('resultAQI').textContent = data.aqi;
        document.getElementById('resultAQI').style.color = data.categoryColor;
        document.getElementById('resultCategory').textContent = data.category;
        document.getElementById('resultCategory').style.color = data.categoryColor;
        document.getElementById('resultRise').innerHTML = `‚¨Ü +${data.rise} AQI from baseline`;
        document.getElementById('baselineAQI').textContent = data.baselineAQI;
        document.getElementById('resultSource').textContent = data.source;
        document.getElementById('resultConfidence').textContent = data.confidence;
        document.getElementById('resultImpact').textContent = data.impact;
        document.getElementById('resultTime').textContent = data.time;
        document.getElementById('healthText').textContent = data.health;
        
        // Populate recommendations
        const recList = document.getElementById('recommendationsList');
        recList.innerHTML = '';
        data.recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recList.appendChild(li);
        });
        
        // Show results section
        resultsSection.classList.add('show');
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function loadResultDetails(predId) {
        // Load specific prediction details - integrate with your backend
        // This would fetch the prediction data and call showResults()
        console.log('Loading prediction:', predId);
    }

    // ===== REAL-TIME AQI FETCHER =====
    const WAQI_TOKEN = '970a0246132c9ee505e98a7e1088c4d4867dbac2';

    // Get AQI color and text color based on value
    function getAQIColor(aqi) {
        if (aqi <= 50) return { bg: '#00e400', text: '#000' };
        if (aqi <= 100) return { bg: '#ffff00', text: '#000' };
        if (aqi <= 200) return { bg: '#ff7e00', text: '#fff' };
        if (aqi <= 300) return { bg: '#ff0000', text: '#fff' };
        return { bg: '#8f3f97', text: '#fff' };
    }

    // Get AQI category name
    function getAQICategory(aqi) {
        if (aqi <= 50) return 'Good';
        if (aqi <= 100) return 'Moderate';
        if (aqi <= 200) return 'Unhealthy';
        if (aqi <= 300) return 'Very Unhealthy';
        return 'Hazardous';
    }

    // Fetch AQI for a specific city
    async function fetchCityAQI(cityName) {
        if (!cityName || cityName.trim() === '') {
            return null;
        }
        
        const currentAqiBadge = document.querySelector('.current-aqi-badge');
        const aqiLabel = document.getElementById('aqi-city-label');
        
        try {
            // Show loading state
            currentAqiBadge.innerHTML = '<span style="font-size: 0.9rem;">‚è≥ Loading...</span>';
            currentAqiBadge.style.background = '#95a5a6';
            currentAqiBadge.style.color = '#fff';
            
            const response = await fetch(
                `https://api.waqi.info/feed/${encodeURIComponent(cityName)}/?token=${WAQI_TOKEN}`
            );
            
            const data = await response.json();
            
            if (data.status === 'ok' && data.data && data.data.aqi) {
                const aqi = data.data.aqi;
                const colors = getAQIColor(aqi);
                const category = getAQICategory(aqi);
                const cityDisplayName = data.data.city?.name || cityName;
                
                // Update AQI badge
                currentAqiBadge.textContent = `${aqi} AQI`;
                currentAqiBadge.style.background = colors.bg;
                currentAqiBadge.style.color = colors.text;
                
                // Update label with city name
                aqiLabel.innerHTML = `Current AQI in <strong>${cityDisplayName}</strong>:`;
                
                // Add tooltip with category and additional info
                currentAqiBadge.title = `${category} - Last updated: ${data.data.time?.s || 'Unknown'}`;
                
                // Store AQI for form submission
                const hiddenAqiInput = document.getElementById('current_aqi_value');
                if (hiddenAqiInput) {
                    hiddenAqiInput.value = aqi;
                }
                
                return aqi;
            } else {
                throw new Error(data.data || 'City not found');
            }
        } catch (error) {
            console.error('Error fetching AQI:', error);
            
            // Show error state
            currentAqiBadge.textContent = 'N/A';
            currentAqiBadge.style.background = '#e74c3c';
            currentAqiBadge.style.color = '#fff';
            currentAqiBadge.title = `Unable to fetch AQI for "${cityName}". Try a different city name.`;
            aqiLabel.innerHTML = `AQI data not available for <strong>${cityName}</strong>:`;
            
            return null;
        }
    }

    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Create debounced fetch function
    const debouncedFetchAQI = debounce((cityName) => {
        fetchCityAQI(cityName);
    }, 1500); // Wait 1.5 seconds after typing stops

    // Initialize AQI fetcher
    function initializeAQIFetcher() {
        const locationInput = document.getElementById('location');
        
        // Auto-fetch on input change (debounced)
        locationInput.addEventListener('input', (e) => {
            const cityName = e.target.value.trim();
            if (cityName.length >= 3) {
                debouncedFetchAQI(cityName);
            }
        });
        
        // Fetch on Enter key
        locationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const cityName = e.target.value.trim();
                if (cityName) {
                    fetchCityAQI(cityName);
                }
            }
        });
        
        // Add "Update AQI" button
        const updateButton = document.createElement('button');
        updateButton.type = 'button';
        updateButton.className = 'btn btn-sm btn-outline-primary mt-2';
        updateButton.innerHTML = 'üîÑ Update AQI';
        updateButton.onclick = () => {
            const cityName = locationInput.value.trim();
            if (cityName) {
                fetchCityAQI(cityName);
            } else {
                alert('Please enter a city name');
            }
        };
        locationInput.parentElement.appendChild(updateButton);
        
        // Fetch initial AQI if location is pre-filled
        const initialCity = locationInput.value.trim();
        if (initialCity) {
            setTimeout(() => fetchCityAQI(initialCity), 500);
        }
    }

    // Run on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAQIFetcher);
    } else {
        initializeAQIFetcher();
    }
</script>
{% endblock %}