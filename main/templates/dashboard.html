{% extends 'base.html' %}

{% block title %}Dashboard - {{ user.username }}{% endblock %}

{% block content %}
<div class="card" style="background: #000; color: #7bed9f; border-color: #7bed9f;">
    <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">‚ñ∂ WELCOME, {{ user.username|upper }}</h1>
    <p style="opacity: 0.8;">RISK LEVEL: <span style="font-weight: bold; color: #fff;">{{ health_profile.get_risk_level_display|upper }}</span></p>
</div>

{% if alerts %}
<div style="margin-bottom: 1.5rem;">
    {% for alert in alerts %}
    <div class="alert alert-{{ alert.level }}">
        {{ alert.message }}
    </div>
    {% endfor %}
</div>
{% endif %}

{# jemit #}
<div class="card">
    <div class="card-header">üåê Live AQI Data</div>
    <div style="text-align: center; padding: 1rem 0;">
        <div style="font-size: 3rem; font-weight: bold; margin-bottom: 0.5rem;" id="aqiValue">--</div>
        <div class="aqi-badge aqi-moderate" id="aqiBadge">Loading...</div>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
            <span id="aqiCity">--</span> ‚Ä¢ <span id="aqiTime">--</span>
        </p>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; padding: 1rem 0; border-top: 2px solid #e0e0e0;">
        <div style="text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">PM2.5</div>
            <div style="font-size: 1.3rem; font-weight: bold;" id="pm25">--</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">PM10</div>
            <div style="font-size: 1.3rem; font-weight: bold;" id="pm10">--</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">NO‚ÇÇ</div>
            <div style="font-size: 1.3rem; font-weight: bold;" id="no2">--</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">CO</div>
            <div style="font-size: 1.3rem; font-weight: bold;" id="co">--</div>
        </div>
    </div>
</div>

<div class="grid">
    <!-- Current AQI -->
    <div class="card">
        <div class="card-header">üìç Your Location AQI</div>
        {% if location_aqi %}
        <div style="text-align: center; padding: 1rem 0;">
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 0.5rem;">
                {{ location_aqi.aqi_value }}
            </div>
            <div class="aqi-badge {% if location_aqi.aqi_value <= 50 %}aqi-good{% elif location_aqi.aqi_value <= 100 %}aqi-moderate{% elif location_aqi.aqi_value <= 200 %}aqi-unhealthy-sensitive{% elif location_aqi.aqi_value <= 300 %}aqi-unhealthy{% elif location_aqi.aqi_value <= 400 %}aqi-very-unhealthy{% else %}aqi-hazardous{% endif %}">
                {{ location_aqi.category }}
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                {{ location_aqi.area }} ‚Ä¢ {{ location_aqi.timestamp|date:"d M Y, h:i A" }}
            </p>
        </div>
        {% else %}
        <p style="text-align: center; padding: 2rem; color: #666;">
            No AQI data available for your location. Update your location in profile settings.
        </p>
        {% endif %}
    </div>

    <!-- Health Profile -->
    <div class="card">
        <div class="card-header">‚ù§Ô∏è Your Health Profile</div>
        <div style="padding: 0.5rem 0;">
            <p style="margin-bottom: 0.5rem;"><strong>Location:</strong> {{ health_profile.location|default:"Not set" }}</p>
            <p style="margin-bottom: 0.5rem;"><strong>Risk Level:</strong> 
                <span class="aqi-badge {% if health_profile.risk_level == 'LOW' %}aqi-good{% elif health_profile.risk_level == 'MODERATE' %}aqi-moderate{% elif health_profile.risk_level == 'HIGH' %}aqi-unhealthy{% else %}aqi-hazardous{% endif %}">
                    {{ health_profile.get_risk_level_display }}
                </span>
            </p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
                <p style="font-size: 0.9rem; color: #666;"><strong>Conditions:</strong></p>
                {% if health_profile.has_respiratory_issues %}<p style="font-size: 0.9rem;">‚Ä¢ Respiratory Issues</p>{% endif %}
                {% if health_profile.has_heart_disease %}<p style="font-size: 0.9rem;">‚Ä¢ Heart Disease</p>{% endif %}
                {% if health_profile.has_allergies %}<p style="font-size: 0.9rem;">‚Ä¢ Allergies</p>{% endif %}
                {% if health_profile.is_elderly %}<p style="font-size: 0.9rem;">‚Ä¢ Age 60+</p>{% endif %}
                {% if health_profile.is_child %}<p style="font-size: 0.9rem;">‚Ä¢ Child (under 12)</p>{% endif %}
                {% if health_profile.is_pregnant %}<p style="font-size: 0.9rem;">‚Ä¢ Pregnant</p>{% endif %}
                {% if not health_profile.has_respiratory_issues and not health_profile.has_heart_disease and not health_profile.has_allergies and not health_profile.is_elderly and not health_profile.is_child and not health_profile.is_pregnant %}
                <p style="font-size: 0.9rem; color: #666;">No health conditions specified</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pollution Sources -->
{% if location_aqi %}
<div class="card">
    <div class="card-header">üîç Pollution Source Breakdown</div>
    <div style="padding: 1rem 0;">
        <p style="margin-bottom: 1rem;"><strong>Primary Source:</strong> {{ location_aqi.primary_source }}</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <div style="background: #f0f0f0; padding: 0.8rem; border: 2px solid #000;">
                    <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">üöó Traffic</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ location_aqi.traffic_contribution|floatformat:1 }}%</div>
                </div>
            </div>
            <div>
                <div style="background: #f0f0f0; padding: 0.8rem; border: 2px solid #000;">
                    <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">üè≠ Industry</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ location_aqi.industrial_contribution|floatformat:1 }}%</div>
                </div>
            </div>
            <div>
                <div style="background: #f0f0f0; padding: 0.8rem; border: 2px solid #000;">
                    <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">üî• Crop Burning</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ location_aqi.crop_burning_contribution|floatformat:1 }}%</div>
                </div>
            </div>
            <div>
                <div style="background: #f0f0f0; padding: 0.8rem; border: 2px solid #000;">
                    <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">üèóÔ∏è Construction</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">{{ location_aqi.construction_contribution|floatformat:1 }}%</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Forecasts -->
<div class="card">
    <div class="card-header">üìä AQI Forecasts (Next 72 Hours)</div>
    {% if forecasts %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f0f0f0; border-bottom: 2px solid #000;">
                    <th style="padding: 0.8rem; text-align: left;">Date & Time</th>
                    <th style="padding: 0.8rem; text-align: center;">Area</th>
                    <th style="padding: 0.8rem; text-align: center;">Predicted AQI</th>
                    <th style="padding: 0.8rem; text-align: center;">Confidence</th>
                </tr>
            </thead>
            <tbody>
                {% for forecast in forecasts %}
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 0.8rem;">{{ forecast.forecast_date|date:"d M Y, h:i A" }}</td>
                    <td style="padding: 0.8rem; text-align: center;">{{ forecast.area }}</td>
                    <td style="padding: 0.8rem; text-align: center;"><strong>{{ forecast.predicted_aqi }}</strong></td>
                    <td style="padding: 0.8rem; text-align: center;">{{ forecast.confidence|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #666;">No forecasts available at the moment.</p>
    {% endif %}
</div>

<!-- Trending Policies -->
<div class="card">
    <div class="card-header">‚öñÔ∏è Trending Policy Proposals</div>
    {% if trending_policies %}
    <div style="padding: 0.5rem 0;">
        {% for policy in trending_policies %}
        <div style="padding: 1rem; margin-bottom: 0.5rem; border: 2px solid #e0e0e0; background: #f9f9f9;">
            <h4 style="margin-bottom: 0.5rem;">{{ policy.title }}</h4>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">{{ policy.description|truncatewords:20 }}</p>
            <div style="display: flex; justify-space-between; align-items: center;">
                <span class="aqi-badge">{{ policy.get_policy_type_display }}</span>
                <div style="font-size: 0.85rem;">
                    <span style="color: #7bed9f; font-weight: bold;">{{ policy.agree_count }} ‚úì</span> / 
                    <span style="color: #ff6b6b; font-weight: bold;">{{ policy.disagree_count }} ‚úó</span>
                </div>
            </div>
        </div>
        {% endfor %}
        <div style="text-align: center; margin-top: 1rem;">
            <a href="{% url 'policies' %}" class="btn btn-secondary">View All Policies ‚Üí</a>
        </div>
    </div>
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #666;">No policies proposed yet.</p>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="grid">
    <a href="{% url 'aqi_map' %}" class="card" style="text-decoration: none; color: inherit; cursor: pointer; transition: transform 0.2s;">
        <div class="card-header">üó∫Ô∏è View AQI Map</div>
        <p style="padding: 1rem 0;">Explore pollution heatmaps and area-wise air quality data.</p>
    </a>
    
    <a href="{% url 'create_policy' %}" class="card" style="text-decoration: none; color: inherit; cursor: pointer; transition: transform 0.2s;">
        <div class="card-header">üí° Propose Policy</div>
        <p style="padding: 1rem 0;">Share your ideas for pollution control policies.</p>
    </a>
    
    <a href="{% url 'policy_simulation' %}" class="card" style="text-decoration: none; color: inherit; cursor: pointer; transition: transform 0.2s;">
        <div class="card-header">‚öôÔ∏è Run Simulation</div>
        <p style="padding: 1rem 0;">Test the impact of different pollution control measures.</p>
    </a>
</div>

<script>
function getAQICategory(aqi) {
    if (aqi <= 50) return { class: 'aqi-good', text: 'Good' };
    if (aqi <= 100) return { class: 'aqi-moderate', text: 'Moderate' };
    if (aqi <= 200) return { class: 'aqi-unhealthy-sensitive', text: 'Unhealthy for Sensitive Groups' };
    if (aqi <= 300) return { class: 'aqi-unhealthy', text: 'Unhealthy' };
    if (aqi <= 400) return { class: 'aqi-very-unhealthy', text: 'Very Unhealthy' };
    return { class: 'aqi-hazardous', text: 'Hazardous' };
}

function loadLiveAQI() {
    fetch("/live-aqi/")
        .then(res => res.json())
        .then(data => {
            if (!data.error) {
                const category = getAQICategory(data.aqi);
                
                document.getElementById("aqiValue").innerText = data.aqi;
                document.getElementById("pm25").innerText = data.pm25 ?? "--";
                document.getElementById("pm10").innerText = data.pm10 ?? "--";
                document.getElementById("no2").innerText = data.no2 ?? "--";
                document.getElementById("co").innerText = data.co ?? "--";
                document.getElementById("aqiTime").innerText = data.time;
                document.getElementById("aqiCity").innerText = data.city;
                
                const badge = document.getElementById("aqiBadge");
                badge.className = 'aqi-badge ' + category.class;
                badge.innerText = category.text;
            }
        })
        .catch(err => {
            console.error("Error loading live AQI:", err);
        });
}

loadLiveAQI();
setInterval(loadLiveAQI, 300000);
</script>

{% endblock %}